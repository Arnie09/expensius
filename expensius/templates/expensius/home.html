{% extends "expensius/base.html" %} 

{% load static %}
{% block content %}
<!-- chart js  -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.3/dist/Chart.min.js"></script>
<!-- js.cookie -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/js-cookie/2.2.1/js.cookie.js"></script>

<style>

    .box{
        text-align: center;
        z-index: 0;
        margin: 0 10px 0 10px;
        box-shadow: 0 5px 15px 2px rgba(0, 0, 0, 0.15);
    }

    .box:hover{
        box-shadow: 0 5px 15px 2px rgba(0, 0, 0, 0.2);
        -webkit-transform: scale(1.005);
        -ms-transform: scale(1.005);
        transform: scale(1.005);
        -webkit-transition: transform 0.2s ease-in-out;
    }

    .navbar{
        background: #fd746c;  /* fallback for old browsers */
        background: -webkit-linear-gradient(to right, #ff9068, #fd746c);  /* Chrome 10-25, Safari 5.1-6 */
        background: linear-gradient(to right, #ff9068, #fd746c); /* W3C, IE 10+/ Edge, Firefox 16+, Chrome 26+, Opera 12+, Safari 7+ */
        /* W3C, IE 10+/ Edge, Firefox 16+, Chrome 26+, Opera 12+, Safari 7+ */
    }

    .account-details{
        height: 700px;
    }

    .h4{
        margin: 10px;
        margin-top: 50px;
    }

    .chart-container{
        background-color: white;
        position: relative;
        margin: auto;
        width: 60vw;
        height: 60vh;
    }

    canvas {
        background-color: white; 
        width: 100%;
        height: auto;
    }

</style>

<!-- navbar  -->
<nav class="navbar navbar-expand-lg navbar-dark shadow" id="mainNav">
    <div class="container-fluid">
        <a class="navbar-brand" href="">Expensius</a>
        <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarResponsive"
            aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse pull-right" id="navbarResponsive">
            <ul class="navbar-nav mr-none">
                <a class="nav-link text-black font-weight-bold" href= "">Hi,{{ user.username }}</a>    
            </ul>
            <ul class="navbar-nav mr-none">
                <a class="nav-link text-black font-weight-bold" href="">About</a>
            </ul>
            <ul class="navbar-nav mr-none">
                <a class="nav-link text-black font-weight-bold" href="{% url 'logout' %}">Logout</a>   
            </ul>
            
        </div>
    </div>
</nav>
<br>
<br>

<!-- account details and chart  -->
<div class="row justify-content-center fluid-resposive">
    <div class="col-md-11 account-details">
        <div class = "row justify-content-center">
            <div class="box col-md-3 col-xs-10 holds-dropdown">
                <br>
                <ul>
                    <h4><b>Account details</b></h4>
                    <h5>Account name: {{ account_name }}</h5>
                    <h5>Current available balance: {{ account_bal }}</h5>

                    <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#ModalTransactionForm">
                        Enter a transaction
                    </button>
                    <br>
                    <br>
                    <button type="button" class="btn btn-danger" data-toggle="modal" data-target="#ModalTransactionDeleteForm">
                        Delete all transactions
                    </button>

                </ul>
            </div>
            <div class="box col-md-8 col-xs-12 right-side holds-graphs justify-content-center">
                <div class="chart-container containerToHoldGraph">
                    <canvas id="myChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<br>
<!-- list of transactions  -->
<div class="row justify-content-center fluid-resposive">
    <div class="box col-md-11 col-xs-10 holds-table">
        <br>
        <ul>
            <h4><b>Transaction details</b></h4>
            <h6><i>Click on a transaction to select it</i></h6>
            <div class = "table-responsive">
                <table class="table table-striped" id = "table-transaction">
                    <thead>
                        <tr>
                        <!-- <th scope="col">#</th> -->
                        <th scope="col">Transaction Date</th>
                        <th scope="col">Transaction with</th>
                        <th scope="col">Transaction Amount</th>
                        <th scope="col">CR/DB</th>
                        <th scope="col">Amount in accnt.</th>
                        <th scope="col">ID</th>
                        </tr>
                    </thead>
                    {% for transaction in transactions %}
                    <tbody>
                        <tr>
                        <td>{{transaction.date|date}}</td>
                        <td>{{transaction.other}}</td>
                        <td>{{transaction.amount}}</td>
                        <td>{{transaction.direction}}</td>
                        <td>{{transaction.amount_accnt}}</td>
                        <td>{{transaction.id}}</td>
                        </tr>
                    </tbody>
                    {% endfor %}
                </table>
            </div>
        </ul>
    </div>
</div>

<div id="ModalTransactionDeleteForm" class="modal fade">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Are you sure you want to delete all transactions?</h5>
            </div>
            <div class="modal-body">
                <form role="form" method="POST" action="">
                    <input type="hidden" name="_token" value="">
                    <div class="form-group">
                        <label class="control-label">Enter your account password</label>
                        <div>
                            <input id = "password_confirm" type="password" class="form-control input-lg" name="amount" value="">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <div>
                            <button class="btn btn-danger" id="confirm_delete" type="button" >Confirm</button>{% csrf_token %}
                            <button type="button" class="btn btn-primary" data-dismiss="modal">Close</button>

                        </div>
                    </div>
                </form>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->


<!-- Modal HTML Markup -->
<div id="ModalTransactionForm" class="modal fade">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title">Enter Transaction details</h1>
            </div>
            <div class="modal-body">
                <form role="form" method="POST" action="">
                    <input type="hidden" name="_token" value="">
                    <div class="form-group">
                        <label class="control-label">Amount</label>
                        <div>
                            <input id = "amount" type="number" class="form-control input-lg" name="amount" value="">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="control-label">To/From</label>
                        <div>
                            <input id = "other" type="text" class="form-control input-lg" name="other">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="control-label">Date</label>
                        <div>
                            <input id = "date" type="date" class="form-control input-lg" name="date">
                        </div>
                    </div>
                    <div class="form-group">
                        <div>
                            <div class="checkbox">
                                <label>
                                    <input id = "direction" type="checkbox" name="direction"> Credit
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <div>
                            <button class="btn btn-primary" id="enter" type="button" >Enter</button>{% csrf_token %}
                        </div>
                    </div>
                </form>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<!-- modal that shows the transaction that was clicked -->
<div id="myModalTransaction" class="modal fade">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title">Transaction</h1>
            </div>
            <div class="modal-body">
                <form role="form" method="POST" action="">
                    <input type="hidden" name="_token" value="">
                    <div class = "form-group">
                        <label class = "control-label">ID</label>
                        <label id = "trans_id" class = "control-label"></label>
                    </div>
                    <div class="form-group">
                        <label class="control-label">Amount</label>
                        <div>
                            <input id = "amount_trans" type="number" class="form-control input-lg" name="amount" value="">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="control-label">To/From</label>
                        <div>
                            <input id = "other_trans" type="text" class="form-control input-lg" name="other">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="control-label">Date</label>
                        <div>
                            <input id = "date_trans" type="date" class="form-control input-lg" name="date">
                        </div>
                    </div>
                    <div class="form-group">
                        <div>
                            <div class="checkbox">
                                <label>
                                    <input id = "direction_trans" type="checkbox" name="direction"> Credit
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <div>
                            <button class="btn btn-primary" id="Edit_transaction" type="button" >Edit</button>{% csrf_token %}
                            <button class="btn btn-danger" id="Delete_transaction" type="button" >Delete</button>{% csrf_token %}
                            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                        </div>
                    </div>
                </form>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<script>
    function convertTime(time){
        var dateObj = new Date(time)
        var month = dateObj.getUTCMonth() + 1; //months from 1-12
        var day = dateObj.getUTCDate();
        var year = dateObj.getUTCFullYear();

        var newdate = day + "/" + month + "/" + year;
        return newdate;
    }
</script>

<!-- script that selects the row of data that the user has clicked on -->
<script>
    $("#table-transaction").click(function(){   
        var t = document.getElementById('table-transaction');
        var rows = t.rows; //rows collection - https://developer.mozilla.org/en-US/docs/Web/API/HTMLTableElement
		for (var i=0; i<rows.length; i++) {
			rows[i].onclick = function (event) {
				//event = event || window.event; // for IE8 backward compatibility
				//console.log(event, this, this.outerHTML);
				if (this.parentNode.nodeName == 'THEAD') {
					return;
				}
				var cells = this.cells; //cells collection
				$("#myModalTransaction").modal('show')

                var date_tran = document.getElementById('date_trans')
				var date = new Date(cells[0].innerHTML);
                date_tran.value = date.getFullYear().toString() + '-' + (date.getMonth() + 1).toString().padStart(2, 0) + '-' + date.getDate().toString().padStart(2, 0);

                var with_tran = document.getElementById('other_trans')
				with_tran.value = cells[1].innerHTML;

                var amount_tran = document.getElementById('amount_trans')
				amount_tran.value = cells[2].innerHTML;
				
                var dir_tran = document.getElementById('direction_trans')
                var bool = cells[3].innerHTML;
                if (bool == "True")
                dir_tran.checked = true;
                else
                dir_tran.checked = false;

                var id_tran = document.getElementById('trans_id')
				id_tran.innerHTML = cells[5].innerHTML;

                
			};
		}
    });

</script>

<!-- ajax funtion for adding new transaction  -->
<script>

    //ajax csrf stuff which I dont understand.
    var csrftoken = Cookies.get('csrftoken')
    function csrfSafeMethod(method) {
        return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
    }
    $.ajaxSetup({
        beforeSend: function(xhr, settings) {
            if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                xhr.setRequestHeader("X-CSRFToken", csrftoken);
            }
        }
    });

    $(document).on('click','#enter',function(e){
        e.preventDefault()
            
            var payload = {
                amount: document.getElementById('amount').value,
                other: document.getElementById('other').value,
                direction: document.getElementById('direction').checked,
                date: document.getElementById('date').value
            }
            var amount = document.getElementById('amount').value;


            $.ajax({
                type:'POST',
                url:'/add_transaction/',
                data:{
                    'payload':payload,
                },
                // This is processing of what we get back
                success:function(msg){
                    var response = msg['mssg']
                    if(response == 1)
                    alert('balance in account cannot be negetive, try again')
                    else if(response == 2)
                    alert('transaction date cannot be a future date, try again')
                    else if(response == 3)
                    alert('current transactions makes some of future transactions invalid')
                    else if(response == 4)
                    alert('transaction was successfully saved')
                    window.location.reload();
                    // update list 
                },
                error:function(){
                    console.log("Error")
                }
                
            });
        })

</script>

<!-- ajax script to delete all transactions -->
<script>
    $(document).on('click','#confirm_delete',function(e){
        e.preventDefault()
            
            var payload = {
                password: document.getElementById('password_confirm').value,
            }

            $.ajax({
                type:'POST',
                url:'/delete_all_transaction/',
                data:{
                    'payload':payload,
                },
                // This is processing of what we get back
                success:function(msg){
                    var response = msg['mssg']
                    if(response == 1){
                        alert("Password entered for the user is incorrect!")
                        window.location.reload();
                    }
                    else if(response == 2){
                        alert("Successfully deleted all your transactions and deleted your account!")
                        window.location.href = "{% url 'account'%}";
                    }
                    // update list 
                },
                error:function(){
                    console.log("Error")
                }
                
            });
    })
</script>

<!-- script for editing a record -->
<script>
    $(document).on('click','#Edit_transaction',function(e){
        e.preventDefault()
            
            var payload = {
                id: document.getElementById('trans_id').innerHTML,
                amount: document.getElementById('amount_trans').value,
                other: document.getElementById('other_trans').value,
                direction: document.getElementById('direction_trans').checked,
                date: document.getElementById('date_trans').value
            }

            $.ajax({
                type:'POST',
                url:'/edit_transaction/',
                data:{
                    'payload':payload,
                },
                // This is processing of what we get back
                success:function(msg){
                    var response = msg['mssg']
                    if(response == 1)
                    alert('balance in account cannot be negetive, try again')
                    else if(response == 2)
                    alert('transaction date cannot be a future date, try again')
                    else if(response == 3)
                    alert('current transactions makes some of future transactions invalid')
                    else if(response == 4)
                    alert('transaction was successfully edited and saved')
                    window.location.reload();
                    // update list 
                },
                error:function(){
                    console.log("Error")
                }
                
            });
    })
</script>

<!-- script for deleting transaction -->
<script>
$(document).on('click','#Delete_transaction',function(e){
        e.preventDefault()
            
            var payload = {
                id: document.getElementById('trans_id').innerHTML,
                amount: document.getElementById('amount_trans').value,
                other: document.getElementById('other_trans').value,
                direction: document.getElementById('direction_trans').checked,
                date: document.getElementById('date_trans').value
            }

            console.log(payload)

            $.ajax({
                type:'POST',
                url:'/delete_transaction/',
                data:{
                    'payload':payload,
                },
                // This is processing of what we get back
                success:function(msg){
                    console.log(payload)
                    var response = msg['mssg']
                    
                    if(response == 3)
                    alert('deleting this transactions makes some of future transactions invalid')
                    else if(response == 4)
                    alert('transaction was successfully deleted')
                    window.location.reload();
                    // update list 
                },
                error:function(){
                    console.log("Error")
                }
                
            });
        })
</script>

<!-- chart showing rules -->
<script>

    var transaction_date = []
    var amount = []
    
    {% for date in transaction_date %}
        var dateObj = new Date('{{ date.isoformat }}')
        var month = dateObj.getUTCMonth() + 1; //months from 1-12
        var day = dateObj.getUTCDate();
        var year = dateObj.getUTCFullYear();

        var newdate = day + "/" + month + "/" + year;
        transaction_date.push(newdate)
    {% endfor %}
    amount = {{transaction_history}}

    var ctx = document.getElementById('myChart').getContext('2d');

    var gradientStroke = ctx.createLinearGradient(500, 0, 400, 0);
    gradientStroke.addColorStop(0, "#80b6f4");
    gradientStroke.addColorStop(1, "#f49080");

    var gradientFill = ctx.createLinearGradient(500, 0, 400, 0);
    gradientFill.addColorStop(0, "rgba(128, 182, 244, 0.6)");
    gradientFill.addColorStop(1, "rgba(244, 144, 128, 0.6)");

    var list = {}
    var myChart = new Chart(ctx, {
        type: 'line',
        data: {
            
            labels: transaction_date,
            datasets: [{
                label: "Amount of money over time",
                data: amount,
                borderColor: gradientStroke,
                pointBorderColor: gradientStroke,
                pointBackgroundColor: gradientStroke,
                pointHoverBackgroundColor: gradientStroke,
                pointHoverBorderColor: gradientStroke,
                backgroundColor:gradientFill,
                pointBorderWidth: 10,
                pointHoverRadius: 10,
                pointHoverBorderWidth: 1,
                pointRadius: 3,
            }]
        },
        options: {
            scales: {
                yAxes: [{
                    ticks: {
                        beginAtZero: true
                    }
                }]
            }
        }
    });
    
    </script>


{% endblock %}